# CLAUDE.md

## Calculateur de Revenu Disponible du Qu√©bec

Calculateur **compl√®tement impl√©ment√©** qui reproduit fid√®lement le calculateur officiel du Minist√®re des Finances du Qu√©bec avec une interface moderne de qualit√© gouvernementale.

**Stack**: Next.js 14, TypeScript, GOV.UK Design System, syst√®me de validation automatis√©

## √âtat de Validation des Programmes

### ‚úÖ Programmes Valid√©s (100% Exactitude)
**Cotisations (5/5)**: RRQ, AE, RQAP, FSS, RAMQ - Valid√©s sur 10 m√©nages types avec exactitude compl√®te

### üîÑ En Attente de Validation Officielle
**Imp√¥ts (2)**: Qu√©bec, F√©d√©ral - Impl√©ment√©s, scraper Python fonctionnel  
**Allocations/Cr√©dits QC (7)**: Solidarit√©, Prime travail, Allocation famille, Fournitures scolaires, Garde enfants, Allocation-logement, Soutien a√Æn√©s  
**Programmes f√©d√©raux (7)**: ACE, Cr√©dit TPS, ACT, PSV+SRG, Suppl√©ments m√©dicaux (2)  
**Aide sociale (1)**: Programme d'assistance financi√®re

### üéØ √âtat Global
**22/22 programmes impl√©ment√©s** | **5/22 valid√©s officiellement** | **Scraper Python op√©rationnel**

### üöÄ Prochaines √âtapes Prioritaires
1. **Valider imp√¥ts QC/f√©d√©ral** avec scraper Python int√©gr√©
2. **Valider cr√©dits/allocations** programme par programme  
3. **Corriger √©carts d√©tect√©s** selon sources officielles
4. **Documentation compl√®te** une fois validation 100% termin√©e

### Architecture
- Interface: `src/components/CompactCalculator.tsx`
- Calculateurs: `src/lib/calculators/` (22 modules)
- Config: `src/lib/config/data/2023-2025.ts`
- Validation: `src/lib/validation/`

## Development Commands

### Essential Commands
```bash
# Install dependencies
npm install

# Development server (port 3001)
npm run dev

# Complete pre-deployment check (MANDATORY before git push)
npm run check

# Type checking
npm run lint
```

### Syst√®me de Validation

#### üêç Validation Officielle Python/Selenium (NOUVEAU - RECOMMAND√â)
Validation contre le calculateur officiel avec scraper Python fonctionnel:

```bash
# Validation progressive officielle (10‚Üí25‚Üí15 cas)
npx tsx src/lib/validation/cli/test-official-validation.ts 2024

# Test simple du scraper Python 
cd python-scraper && uv run multi_test.py

# Validation en mode debug visuel
cd python-scraper && uv run debug_visual.py
```

**‚úÖ Scraper Python r√©sout le probl√®me Puppeteer:**
- **Avant**: R√©sultats erron√©s (147026$ au lieu de 20387$)
- **Apr√®s**: R√©sultats corrects avec variabilit√© confirm√©e
- **M√©thode robuste**: JavaScript fallback + gestion cookies

#### Validation Progressive TypeScript (Ancienne m√©thode)
```bash
# Validation progressive standard  
npm run validate:progressive -- --count 25

# Validation pour ann√©e fiscale sp√©cifique
npm run validate:progressive:2025
```

#### Validation Rapide par Programme
```bash
# Tester un programme sp√©cifique (ex: RAMQ)
npm run validate:ramq

# Validation tableau de bord web
# http://localhost:3001/validation
```

## Sp√©cifications Techniques

### Caract√©ristiques Cl√©s
- **Port 3001**: √âvite conflit avec Docusaurus (port 3000)
- **Pr√©cision mon√©taire**: Decimal.js avec ROUND_HALF_UP
- **Ann√©es fiscales**: Support 2023-2025 avec validation TypeScript
- **Logique d'√¢ge**: 18-64 (travail) vs 65+ (retraite)

### Standards Interface
- **Design GOV.UK**: Interface gouvernementale professionnelle
- **Accessibilit√©**: WCAG 2.1 AA, navigation clavier compl√®te
- **Responsive**: Mobile-first, breakpoints appropri√©s

## Strat√©gie de Validation

### Approche de Validation Progressive

La validation progressive est la m√©thode recommand√©e pour v√©rifier l'exactitude du calculateur:

#### M√©thodologie
1. **Comparaison Programme par Programme**: Chaque programme socio-fiscal est valid√© individuellement
2. **M√©nages Types Vari√©s**: G√©n√©ration automatique de profils de m√©nages diversifi√©s
3. **Validation Contre Source Officielle**: Comparaison directe avec le calculateur du Minist√®re des Finances
4. **Corrections Bas√©es sur des Sources**: Toute correction doit √™tre justifi√©e par documentation officielle

#### Workflow de Validation
```bash
# √âtape 1: Validation de base (10-25 m√©nages)
npm run validate:progressive -- --count 25
# ‚Üí Identifier les √©carts par programme
# ‚Üí Corriger selon sources officielles
# ‚Üí R√©p√©ter jusqu'√† exactitude

# √âtape 2: Validation √©tendue (100+ m√©nages)
npm run validate:progressive -- --count 100
# ‚Üí Tester cas particuliers
# ‚Üí D√©tecter r√©gressions
# ‚Üí Valider stabilit√©
```

#### Standards de Correction
- **Sources Officielles**: Sites gouvernementaux, guides fiscaux officiels
- **√âcarts Significatifs**: Diff√©rences >5% n√©cessitent correction document√©e
- **Tra√ßabilit√©**: Toute correction r√©f√©renc√©e dans les commits

## üêç Syst√®me de Scraping Python/Selenium

### ‚úÖ Scraper Op√©rationnel (Septembre 2024)
**Probl√®me Puppeteer r√©solu** avec migration Python/Selenium:
- **Avant**: Valeurs bloqu√©es √† 147026$ (bug Puppeteer)  
- **Apr√®s**: R√©sultats corrects et variables (ex: 20387$ pour 15000$)

### Architecture du Scraper
**Fichiers Python** (`python-scraper/`):
- `calculator_scraper.py` - Scraper principal Selenium
- `simple_test.py` - Test basique 
- `multi_test.py` - Tests multiples avec variabilit√©
- `debug_visual.py` - Debug mode visuel (navigateur visible)

**Int√©gration TypeScript** (`src/lib/validation/`):
- `PythonOfficialCalculatorScraper.ts` - Wrapper TypeScript ‚Üí Python  
- `OfficialValidationEngine.ts` - Moteur de validation complet
- `ProgressiveValidationRunner.ts` - Validation progressive int√©gr√©e

### Fonctionnalit√©s Cl√©s
- ‚úÖ **Gestion cookies robuste** (XPath + s√©lecteurs CSS fallback)
- ‚úÖ **Extraction 22 programmes** avec s√©lecteurs corrects  
- ‚úÖ **M√©thode JavaScript fallback** pour champs r√©calcitrants
- ‚úÖ **Formatage fran√ßais g√©r√©** (espaces comme s√©parateurs de milliers)
- ‚úÖ **Int√©gration uv + TypeScript** via spawn process

### S√©lecteurs Corrig√©s
- Formulaire: `#Situation`, `#Revenu1/2`, `#AgeAdulte1/2`, `#NbEnfants`
- R√©sultats: `#RD_new`, `#CA_ae_new`, `#QC_ramq_new`, `#CA_pfrt_new`, etc.
- Types m√©nage: "Personne vivant seule", "Couple", "Retrait√© vivant seul"

## üéØ VALIDATION PROGRESSIVE ACTIVE

**Cotisations valid√©es √† 100%** - Scraper Python pr√™t pour validation compl√®te des 17 programmes restants

## D√©ploiement

### Status Actuel
‚úÖ **EN LIGNE**: https://boisalai.github.io/revdisp/
- D√©ploiement automatique via GitHub Actions
- Export statique optimis√© pour GitHub Pages

### Workflow Pr√©-D√©ploiement
‚ö†Ô∏è **OBLIGATOIRE avant chaque push**:
```bash
npm run check  # Validation compl√®te
```

### Rollback d'Urgence
```bash
git revert HEAD
git push origin main
```

## Bonnes Pratiques

### Checklist Pr√©-D√©ploiement
1. ‚úÖ **Toujours ex√©cuter `npm run check`**
2. ‚úÖ **V√©rifier les erreurs console**
3. ‚úÖ **Tester fonctionnalit√©s client**

### Gestion Configuration
Tous les calculateurs doivent avoir leurs cl√©s dans:
- `src/lib/config/data/2023.ts`
- `src/lib/config/data/2024.ts`  
- `src/lib/config/data/2025.ts`

### Workflow Git
```bash
git add .
git commit -m "description"
git push origin main  # Hook automatique npm run check
```

## M√©thodologie d'Impl√©mentation

### Processus Standard
1. **Recherche**: Sources officielles, d√©pendances, cas particuliers
2. **Planification**: Architecture, interfaces, param√®tres fiscaux
3. **D√©veloppement**: Calculateur + UI + tests int√©gr√©s
4. **Validation**: Tests massifs + corrections it√©ratives
5. **Documentation**: Mise √† jour docs + d√©ploiement

### üîß Notes Techniques Importantes
- **Port 3001**: Application accessible via Playwright/tests
- **uv**: Gestionnaire Python utilis√© pour scraper (`cd python-scraper && uv run`)
- **Timeout scraper**: 60s par d√©faut pour √©viter timeouts  
- **D√©lais entre tests**: 2s pour √©viter surcharge serveur officiel
- **Mode headless**: Par d√©faut, mode `visible` disponible pour debug

### üö® Limitations Actuelles
- **RAMQ couples**: Calcul incorrect (737.50$ vs 1475$ attendu)
- **Programmes non-valid√©s**: 17/22 en attente de validation officielle
- **Volume limit√©**: Max 25-50 cas par session pour √©viter d√©tection bot

## Conventions de Nommage

**IMPORTANT**: Ce codebase utilise **underscore_case** pour toutes les propri√©t√©s principales des r√©sultats de calcul.

**‚úÖ CORRECT**:
```typescript
const result = calculationResult.revenu_disponible
const taxes = calculationResult.impot_quebec
const config = getConfigValue('senior_support')
```

**‚ùå INCORRECT**:
```typescript
const result = calculationResult.revenuDisponible  // ‚ùå
const taxes = calculationResult.impotQuebec        // ‚ùå
```

**Zones concern√©es**: R√©sultats calculateur, cl√©s configuration, propri√©t√©s API, syst√®me validation

## üìã Quick Reference pour Prochaines Sessions

### Commandes Essentielles
```bash
# D√©marrage rapide
npm run dev                                    # Port 3001

# Validation scraper Python (RECOMMAND√â)
npx tsx src/lib/validation/cli/test-official-validation.ts 2024

# Test scraper Python direct  
cd python-scraper && uv run multi_test.py

# Check complet avant commit
npm run check

# RAMQ debug (probl√®me connu couples)
npm run validate:ramq
```

### Fichiers Cl√©s √† Conna√Ætre
```
src/lib/validation/
‚îú‚îÄ‚îÄ PythonOfficialCalculatorScraper.ts    # Wrapper TypeScript‚ÜíPython
‚îú‚îÄ‚îÄ OfficialValidationEngine.ts           # Moteur validation complet  
‚îî‚îÄ‚îÄ ProgressiveValidationRunner.ts        # Validation progressive

python-scraper/
‚îú‚îÄ‚îÄ calculator_scraper.py                 # Scraper principal 
‚îú‚îÄ‚îÄ multi_test.py                         # Tests variabilit√©
‚îî‚îÄ‚îÄ debug_visual.py                       # Debug mode visible

src/lib/calculators/
‚îú‚îÄ‚îÄ RamqCalculator.ts                     # ‚ö†Ô∏è Bug couples √† corriger
‚îú‚îÄ‚îÄ FssCalculator.ts                      # ‚úÖ Valid√© 100%
‚îî‚îÄ‚îÄ [autres calculateurs]                 # üîÑ En attente validation
```

### √âtat des Travaux
- ‚úÖ **5/22 programmes valid√©s** (toutes cotisations)
- üêç **Scraper Python fonctionnel** (r√©sout probl√®me Puppeteer) 
- üîÑ **17 programmes √† valider** avec nouveau scraper
- üö® **1 bug connu**: RAMQ couples (737.50$ vs 1475$ attendu)