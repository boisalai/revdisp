# CLAUDE.md

## Calculateur de Revenu Disponible du Qu√©bec

Calculateur **compl√®tement impl√©ment√©** qui reproduit fid√®lement le calculateur officiel du Minist√®re des Finances du Qu√©bec avec une interface moderne de qualit√© gouvernementale.

**Stack**: Next.js 14, TypeScript, Ubuntu Font, GOV.UK Design System, syst√®me de validation automatis√©

## √âtat de Validation des Programmes

### ‚úÖ Programmes Valid√©s (100% Exactitude)
**Cotisations (5/5)**: RRQ, AE, RQAP, FSS, RAMQ - Valid√©s sur 10 m√©nages types avec exactitude compl√®te

### üîÑ En Attente de Validation Officielle
**Imp√¥ts (2)**: Qu√©bec, F√©d√©ral - Impl√©ment√©s, scraper Python fonctionnel  
**Allocations/Cr√©dits QC (7)**: Solidarit√©, Prime travail, Allocation famille, Fournitures scolaires, Garde enfants, Allocation-logement, Soutien a√Æn√©s  
**Programmes f√©d√©raux (7)**: ACE, Cr√©dit TPS, ACT, PSV+SRG, Suppl√©ments m√©dicaux (2)  
**Aide sociale (1)**: Programme d'assistance financi√®re

### üéØ √âtat Global
**22/22 programmes impl√©ment√©s** | **5/22 valid√©s officiellement** | **Scraper Python op√©rationnel**

### üöÄ Prochaines √âtapes Prioritaires
1. **Valider imp√¥ts QC/f√©d√©ral** avec scraper Python int√©gr√©
2. **Valider cr√©dits/allocations** programme par programme  
3. **Corriger √©carts d√©tect√©s** selon sources officielles
4. **Documentation compl√®te** une fois validation 100% termin√©e

### Architecture
- Interface: `src/components/CompactCalculator.tsx`
- Calculateurs: `src/lib/calculators/` (22 modules)
- Config: `src/lib/config/data/2023-2025.ts`
- Validation: `src/lib/validation/`

## Development Commands

### Essential Commands
```bash
# Install dependencies
npm install

# Development server (port 3001)
npm run dev

# Complete pre-deployment check (MANDATORY before git push)
npm run check

# Type checking
npm run lint
```

### Syst√®me de Validation

#### üéØ Validation Unifi√©e (RECOMMAND√â)
**Script principal unique** qui remplace tous les autres scripts de validation:

```bash
# Validation avec 10 m√©nages al√©atoires pour 2024
npx tsx src/lib/validation/cli/simple-unified-validation.ts --count=10 --year=2024

# Validation √©tendue avec 100 m√©nages pour 2025
npx tsx src/lib/validation/cli/simple-unified-validation.ts --count=100 --year=2025

# Test rapide avec 5 m√©nages
npx tsx src/lib/validation/cli/simple-unified-validation.ts --count=5 --year=2024
```

**‚úÖ Fonctionnalit√©s du Script Unifi√©:**
- **G√©n√©ration al√©atoire** de m√©nages types (single/couple, √¢ges 18-64, revenus 0-80k$)
- **Comparaison automatique** avec calculateur officiel du MFQ
- **Identification du pire cas** avec √©carts les plus importants
- **Tableau d√©taill√©** programme par programme
- **Recommandations de corrections** bas√©es sur l'analyse des √©carts

#### üêç Tests Scraper Python Direct
```bash
# Test simple du scraper Python 
cd python-scraper && uv run multi_test.py

# Validation en mode debug visuel
cd python-scraper && uv run debug_visual.py
```

#### üîç Architecture de Validation (4 fichiers essentiels)

**`src/lib/validation/`** contient uniquement:

1. **`cli/simple-unified-validation.ts`** 
   - üéØ **Script principal unifi√©** 
   - Remplace 23+ anciens scripts de validation
   - G√©n√©ration m√©nages al√©atoires + comparaison MFQ
   - Tableaux d√©taill√©s + recommandations

2. **`PythonOfficialCalculatorScraper.ts`**
   - üêç **Wrapper TypeScript ‚Üí Python**
   - Interface entre TypeScript et scraper Selenium
   - Gestion processus Python + parsing r√©sultats

3. **`OfficialValidationEngine.ts`**
   - üîß **Moteur de validation complet**
   - Orchestration validations multi-programmes
   - Calcul m√©triques de pr√©cision

4. **`OfficialCalculatorScraper.ts`**
   - üìú **Scraper original JavaScript**
   - Version Puppeteer conserv√©e pour r√©f√©rence
   - Remplac√© par version Python plus robuste

## Sp√©cifications Techniques

### Caract√©ristiques Cl√©s
- **Port 3001**: √âvite conflit avec Docusaurus (port 3000)
- **Pr√©cision mon√©taire**: Decimal.js avec ROUND_HALF_UP
- **Ann√©es fiscales**: Support 2023-2025 avec validation TypeScript
- **Logique d'√¢ge**: 18-64 (travail) vs 65+ (retraite)

### Standards Interface
- **Design GOV.UK**: Interface gouvernementale professionnelle avec police Ubuntu
- **Accessibilit√©**: WCAG 2.1 AA, navigation clavier compl√®te
- **Responsive**: Mobile-first, breakpoints appropri√©s
- **Typographie**: Police Ubuntu pour lisibilit√© optimale

## Strat√©gie de Validation

### Approche de Validation Progressive

La validation progressive est la m√©thode recommand√©e pour v√©rifier l'exactitude du calculateur:

#### M√©thodologie
1. **Comparaison Programme par Programme**: Chaque programme socio-fiscal est valid√© individuellement
2. **M√©nages Types Vari√©s**: G√©n√©ration automatique de profils de m√©nages diversifi√©s
3. **Validation Contre Source Officielle**: Comparaison directe avec le calculateur du Minist√®re des Finances
4. **Corrections Bas√©es sur des Sources**: Toute correction doit √™tre justifi√©e par documentation officielle

#### Workflow de Validation Moderne
```bash
# √âtape 1: Validation de base (10-25 m√©nages)
npx tsx src/lib/validation/cli/simple-unified-validation.ts --count=25 --year=2024
# ‚Üí Identifier les √©carts par programme
# ‚Üí Analyser le pire cas dans le tableau d√©taill√©
# ‚Üí Suivre les recommandations de corrections

# √âtape 2: Validation √©tendue (100+ m√©nages)  
npx tsx src/lib/validation/cli/simple-unified-validation.ts --count=100 --year=2024
# ‚Üí Tester cas particuliers avec variabilit√©
# ‚Üí D√©tecter r√©gressions sur gros volume
# ‚Üí Valider stabilit√© et coh√©rence
```

#### Standards de Correction
- **Sources Officielles**: Sites gouvernementaux, guides fiscaux officiels
- **√âcarts Significatifs**: Diff√©rences >5% n√©cessitent correction document√©e
- **Tra√ßabilit√©**: Toute correction r√©f√©renc√©e dans les commits

## üêç Syst√®me de Scraping Python/Selenium

### ‚úÖ Scraper Op√©rationnel (Septembre 2024)
**Probl√®me Puppeteer r√©solu** avec migration Python/Selenium:
- **Avant**: Valeurs bloqu√©es √† 147026$ (bug Puppeteer)  
- **Apr√®s**: R√©sultats corrects et variables (ex: 20387$ pour 15000$)

### Architecture du Scraper
**Fichiers Python** (`python-scraper/`):
- `calculator_scraper.py` - Scraper principal Selenium
- `simple_test.py` - Test basique 
- `multi_test.py` - Tests multiples avec variabilit√©
- `debug_visual.py` - Debug mode visuel (navigateur visible)

**Int√©gration TypeScript** (`src/lib/validation/`):
- `PythonOfficialCalculatorScraper.ts` - Wrapper TypeScript ‚Üí Python  
- `OfficialValidationEngine.ts` - Moteur de validation complet
- `OfficialCalculatorScraper.ts` - Scraper Puppeteer (r√©f√©rence legacy)

### Fonctionnalit√©s Cl√©s
- ‚úÖ **Gestion cookies robuste** (XPath + s√©lecteurs CSS fallback)
- ‚úÖ **Extraction 22 programmes** avec s√©lecteurs corrects  
- ‚úÖ **M√©thode JavaScript fallback** pour champs r√©calcitrants
- ‚úÖ **Formatage fran√ßais g√©r√©** (espaces comme s√©parateurs de milliers)
- ‚úÖ **Int√©gration uv + TypeScript** via spawn process

### S√©lecteurs Corrig√©s
- Formulaire: `#Situation`, `#Revenu1/2`, `#AgeAdulte1/2`, `#NbEnfants`
- R√©sultats: `#RD_new`, `#CA_ae_new`, `#QC_ramq_new`, `#CA_pfrt_new`, etc.
- Types m√©nage: "Personne vivant seule", "Couple", "Retrait√© vivant seul"

## üéØ VALIDATION PROGRESSIVE ACTIVE

**Cotisations valid√©es √† 100%** - Scraper Python pr√™t pour validation compl√®te des 17 programmes restants

## D√©ploiement

### Status Actuel
‚úÖ **EN LIGNE**: https://boisalai.github.io/revdisp/
- D√©ploiement automatique via GitHub Actions
- Export statique optimis√© pour GitHub Pages

### Workflow Pr√©-D√©ploiement
‚ö†Ô∏è **OBLIGATOIRE avant chaque push**:
```bash
npm run check  # Validation compl√®te
```

### Rollback d'Urgence
```bash
git revert HEAD
git push origin main
```

## Bonnes Pratiques

### Checklist Pr√©-D√©ploiement
1. ‚úÖ **Toujours ex√©cuter `npm run check`**
2. ‚úÖ **V√©rifier les erreurs console**
3. ‚úÖ **Tester fonctionnalit√©s client**

### Gestion Configuration
Tous les calculateurs doivent avoir leurs cl√©s dans:
- `src/lib/config/data/2023.ts`
- `src/lib/config/data/2024.ts`  
- `src/lib/config/data/2025.ts`

### Workflow Git
```bash
git add .
git commit -m "description"
git push origin main  # Hook automatique npm run check
```

## M√©thodologie d'Impl√©mentation

### Processus Standard
1. **Recherche**: Sources officielles, d√©pendances, cas particuliers
2. **Planification**: Architecture, interfaces, param√®tres fiscaux
3. **D√©veloppement**: Calculateur + UI + tests int√©gr√©s
4. **Validation**: Tests massifs + corrections it√©ratives
5. **Documentation**: Mise √† jour docs + d√©ploiement

### üîß Notes Techniques Importantes
- **Port 3001**: Application accessible via Playwright/tests
- **uv**: Gestionnaire Python utilis√© pour scraper (`cd python-scraper && uv run`)
- **Timeout scraper**: 60s par d√©faut pour √©viter timeouts  
- **D√©lais entre tests**: 2s pour √©viter surcharge serveur officiel
- **Mode headless**: Par d√©faut, mode `visible` disponible pour debug

### üö® Limitations Actuelles
- **RAMQ couples**: Calcul incorrect (737.50$ vs 1475$ attendu)
- **Programmes non-valid√©s**: 17/22 en attente de validation officielle
- **Volume limit√©**: Max 25-50 cas par session pour √©viter d√©tection bot

## üéØ Estimation Revenu Familial Net (Ligne 275) - Approche Empirique

### Contexte et D√©fi

Les **cr√©dits d'imp√¥t remboursables** (cr√©dit solidarit√©, prime au travail) d√©pendent du **revenu familial net** (ligne 275 de la d√©claration qu√©b√©coise), mais celui-ci n'est g√©n√©ralement pas disponible dans un simulateur bas√© sur les revenus bruts.

### M√©thode Empirique Document√©e

**üîß Approche utilis√©e** : Calibration des taux de d√©duction par analyse comparative avec le calculateur officiel du Minist√®re des Finances du Qu√©bec.

#### Processus de Calibration

1. **Tests multiples** avec m√©nages vari√©s via le scraper Python/Selenium
2. **Analyse des seuils** o√π les cr√©dits deviennent z√©ro dans le calculateur officiel
3. **D√©duction inverse** des taux de d√©duction n√©cessaires
4. **Validation empirique** sur nouveaux cas de test

#### Taux de D√©duction Calibr√©s (2024)

```typescript
// Estimation ligne 275 = Revenu brut √ó (1 - taux_d√©duction)
// Taux calibr√©s contre calculateur officiel MFQ

if (totalGrossIncome.lessThan(30000)) {
  deductionRate = 0.12  // 12% - Bas revenus
} else if (totalGrossIncome.lessThan(50000)) {
  deductionRate = 0.16  // 16% - Revenus moyens-bas  
} else if (totalGrossIncome.lessThan(80000)) {
  deductionRate = 0.22  // 22% - Revenus moyens
} else if (totalGrossIncome.lessThan(120000)) {
  deductionRate = 0.35  // 35% - Revenus √©lev√©s (calibr√© pour seuils cr√©dits)
} else {
  deductionRate = 0.45  // 45% - Tr√®s hauts revenus
}
```

#### Exemple de Calibration

**Cr√©dit solidarit√©** : Seuil d'√©limination ~61,500$ pour couples
- **Couple 90k$** ‚Üí MFQ donne 0$ cr√©dit
- **Calcul inverse** : 90k$ √ó (1-X) ‚â§ 61,500$ ‚Üí X ‚â• 32%
- **Validation** : Taux 35% ‚Üí 90k$ √ó 0.65 = 58,500$ ‚úÖ

### Pr√©cision Obtenue

- **Pr√©cision globale** : 96-97% en moyenne
- **Cas parfaits** : Revenus moyens (40-70k$) atteignent souvent 99-100%
- **Limitation** : Couples tr√®s hauts revenus (110k$+) n√©cessiteraient taux ~45-50%

### Avantages de l'Approche

‚úÖ **M√©thodologie document√©e** et reproductible
‚úÖ **Bas√©e sur observations factuelles** du calculateur officiel  
‚úÖ **Pas d'assumptions non-document√©es** (ex: cotisations d√©ductibles)
‚úÖ **Transparente** : taux ajustables selon nouvelles donn√©es
‚úÖ **Maintient haute pr√©cision** g√©n√©rale du syst√®me

### Fichiers Concern√©s

- `src/lib/calculators/SolidarityCalculator.ts` - Cr√©dit solidarit√©
- `src/lib/calculators/WorkPremiumCalculator.ts` - Prime au travail  
- M√©thode : `calculateFamilyNetIncome()`

### Am√©lioration Future

**Int√©gration avec calculateurs d'imp√¥t** : Remplacer l'estimation par calcul direct de la ligne 275 quand les calculateurs QC/f√©d√©ral seront int√©gr√©s au syst√®me.

## Conventions de Nommage

**IMPORTANT**: Ce codebase utilise **underscore_case** pour toutes les propri√©t√©s principales des r√©sultats de calcul.

**‚úÖ CORRECT**:
```typescript
const result = calculationResult.revenu_disponible
const taxes = calculationResult.impot_quebec
const config = getConfigValue('senior_support')
```

**‚ùå INCORRECT**:
```typescript
const result = calculationResult.revenuDisponible  // ‚ùå
const taxes = calculationResult.impotQuebec        // ‚ùå
```

**Zones concern√©es**: R√©sultats calculateur, cl√©s configuration, propri√©t√©s API, syst√®me validation

## üö® DISTINCTION CRITIQUE : Imp√¥ts vs R√©gimes Fiscaux

**‚ö†Ô∏è ERREUR FR√âQUENTE √Ä √âVITER** : Confusion entre imp√¥ts bruts et r√©gimes fiscaux nets

### D√©finitions Cl√©s
- **Imp√¥t sur le revenu des particuliers** = Imp√¥t BRUT calcul√© avant tous cr√©dits
- **R√©gime fiscal** = Impact NET (imp√¥t brut - cr√©dits/allocations du m√™me niveau gouvernemental)

### Exemple concret (personne seule, 35 ans, 45000$)
**QU√âBEC**:
- Imp√¥t particuliers QC : -3 291 $ (brut)
- R√©gime fiscal QC : -2 193 $ (net apr√®s cr√©dit solidarit√© +1 098 $)

**F√âD√âRAL**:
- Imp√¥t particuliers f√©d√©ral : -3 055 $ (brut)
- R√©gime fiscal f√©d√©ral : -2 549 $ (net apr√®s cr√©dit TPS +506 $)

### Dans le calculateur officiel
- Les sections "R√©gime fiscal du Qu√©bec" et "R√©gime fiscal f√©d√©ral" montrent les montants NETS
- Les lignes "Imp√¥t sur le revenu des particuliers" montrent les montants BRUTS
- Les cr√©dits/allocations sont les diff√©rences qui expliquent l'√©cart

**üéØ R√àGLE** : Toujours v√©rifier si on parle d'imp√¥t brut ou de r√©gime fiscal net lors des analyses

## üßπ Historique des Changements R√©cents

### Septembre 2024 - Nettoyage Structure & UI
**‚úÖ Nettoyage projet complet (Sept 2024)**:
- üóëÔ∏è **Supprim√© 90+ fichiers obsol√®tes** (~200MB lib√©r√©s)
- üìã **Documentation legacy supprim√©e**: PROJECT_STRUCTURE.md, VALIDATION-SYSTEM.md, PLAN-AIDE-SOCIALE.md
- üìä **Rapports temporaires nettoy√©s**: validation-reports/, reports/, demo-reports/
- üß™ **Scripts legacy supprim√©s**: tests/, validate-ei*.js, fichiers Python dupliqu√©s
- üé® **Police chang√©e**: Onest ‚Üí Ubuntu pour interface moderne
- üèóÔ∏è **Structure simplifi√©e** selon architecture unifi√©e

**‚úÖ Syst√®me de validation consolid√©**:
- üéØ **Script unifi√© unique**: `simple-unified-validation.ts` remplace 20+ anciens scripts
- üêç **Scraper Python op√©rationnel**: Remplace Puppeteer d√©faillant
- üîß **Architecture √©pur√©e**: 4 fichiers essentiels seulement

## üìã Quick Reference pour Prochaines Sessions

### Commandes Essentielles
```bash
# D√©marrage rapide
npm run dev                                    # Port 3001

# Validation unifi√©e (RECOMMAND√â) - Script principal
npx tsx src/lib/validation/cli/simple-unified-validation.ts --count=10 --year=2024

# Test scraper Python direct  
cd python-scraper && uv run multi_test.py

# Check complet avant commit (OBLIGATOIRE)
npm run check
```

### Fichiers Cl√©s √† Conna√Ætre
```
src/lib/validation/                        # ‚úÖ Architecture √©pur√©e
‚îú‚îÄ‚îÄ cli/simple-unified-validation.ts      # üéØ Script principal unifi√©
‚îú‚îÄ‚îÄ PythonOfficialCalculatorScraper.ts    # üêç Wrapper TypeScript‚ÜíPython
‚îú‚îÄ‚îÄ OfficialValidationEngine.ts           # üîß Moteur validation complet
‚îî‚îÄ‚îÄ OfficialCalculatorScraper.ts          # üìú Scraper original (r√©f√©rence)

python-scraper/                           # ‚úÖ Scraper Python fonctionnel
‚îú‚îÄ‚îÄ calculator_scraper.py                 # Scraper principal Selenium
‚îú‚îÄ‚îÄ multi_test.py                         # Tests variabilit√©
‚îú‚îÄ‚îÄ debug_visual.py                       # Debug mode visible
‚îú‚îÄ‚îÄ simple_test.py                        # Test basique
‚îî‚îÄ‚îÄ test_scraper.py                       # Tests avanc√©s

src/lib/calculators/                       # ‚úÖ 22 calculateurs impl√©ment√©s
‚îú‚îÄ‚îÄ RamqCalculator.ts                     # ‚ö†Ô∏è Bug couples √† corriger
‚îú‚îÄ‚îÄ FssCalculator.ts                      # ‚úÖ Valid√© 100%
‚îú‚îÄ‚îÄ SocialAssistanceCalculator.ts         # ‚úÖ Aide sociale compl√®te
‚îî‚îÄ‚îÄ [19 autres calculateurs]              # üîÑ En attente validation

src/components/                            # ‚úÖ Interface Ubuntu moderne
‚îú‚îÄ‚îÄ CompactCalculator.tsx                 # Interface principale
‚îî‚îÄ‚îÄ DetailedResults.tsx                   # Affichage r√©sultats
```

### √âtat des Travaux
- ‚úÖ **5/22 programmes valid√©s** (toutes cotisations)
- üêç **Scraper Python fonctionnel** (r√©sout probl√®me Puppeteer) 
- üîÑ **17 programmes √† valider** avec nouveau scraper
- üö® **1 bug connu**: RAMQ couples (737.50$ vs 1475$ attendu)
- üé® **Interface moderne**: Police Ubuntu, design GOV.UK, structure √©pur√©e